# como se fosse dev
# um novo arquivo apenas para fins didaticos

include:
  - ./external.api/docker-compose.external-api.yaml

services:
  web1:
    extends:
      file: docker-compose.common.yaml
      service: web
    ports:
      - 3000:3000
    depends_on:
      db:
        condition: service_healthy
        # restart: true

  web2:
    extends:
      file: docker-compose.common.yaml
      service: web
    profiles: [nginx]
    ports:
      - 3001:3000
    depends_on:
      db:
        condition: service_healthy
        # restart: true

  nginx:
    build: ./.docker/nginx
    profiles: [nginx]
    restart: always
    ports:
      - 4000:80
    # volumes:
    #   - ./.docker/nginx/nginx.conf:/etc/nginx/nginx.conf
    develop:
      watch: # hot reload
        - action: sync+restart
          x-initialSync: true
          path: ./.docker/nginx/nginx.conf
          target: /etc/nginx/nginx.conf
  db:
    image: mysql:8.0.30-debian
    platform: linux/amd64
    restart: on-failure:5 | always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: my_database
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 30s # com que frequencia o healthcheck vai ser executado
      timeout: 5s # quanto tempo o healthcheck vai demorar para responder ao ping do mysql no container mysql
      retries: 5 # quantas vezes o healthcheck vai tentar se conectar ao mysql antes de dar erro
      start_period: 10s # quanto tempo o healthcheck vai demorar para iniciar antes de dar erro ao mysql
      # ou seja, o healthcheck sera executado a cada 30s e se ele nao responder em 5s ele ira dar um erro e 5 tentativas de delay antes de dar erro ao mysql e 10s de delay antes de comecar o healthcheck
    # depends_on:
    #   - xpto
    # networks:
    #   - externalapi_default

  # xpto: apenas para exemplificar o uso do restart no container do mysql
  #   image: xpto:latest
  # networks:
  #   externalapi_default:
  #     external: true

  phpmyadmin:
    image: phpmyadmin:5.2.1-apache
    profiles: [debug]
    environment:
      PMA_HOST: db
      PMA_USER: root
      PMA_PASSWORD: root
      PMA_PORT: 3306
    ports:
      - 8080:80
    depends_on:
      db:
        condition: service_healthy

# 127.0.0.1 host.docker.internal
# volume (n√£o foi criado para dev)
# i/o bloqueante - 2 processos
# watch (foi criado para dev)
# i/o nao bloqueante - 1 processo
